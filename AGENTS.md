# Repository Guidelines

## Project Structure & Module Organization
- frontend: Create React App (CRA) app. Include `package.json`, source under `src/`, build output in `build/`.
- backend: Cloudflare Worker (`worker.js`) and `wrangler.toml` (auto-generated by scripts). Optional `schema.sql` for D1.
- router, worker: Reserved folders (use if you split concerns further).
- scripts: Deployment and maintenance scripts (shell + PowerShell).
- .env.example: Required/optional environment variables.

## Build, Test, and Development Commands
- Deploy (Linux/macOS): `export CLOUDFLARE_API_TOKEN=... CLOUDFLARE_ACCOUNT_ID=... CF_PAGES_PROJECT=... REACT_APP_API_ORIGIN=... && bash scripts/deploy_cloudflare.sh` — builds CRA, ensures D1, deploys Worker + Pages.
- Deploy (Windows): Set env vars, then `powershell -ExecutionPolicy Bypass -File scripts/deploy_cloudflare.ps1`.
- Verify Cloudflare stack: `bash scripts/verify_stack.sh` — prints Wrangler version, D1 DBs, Pages projects.
- Attach custom domain: `bash scripts/link_domain.sh` (requires `CF_PAGES_PROJECT` and `CF_PAGES_DOMAIN`).
- Local frontend dev: `cd frontend && npm install && npm start`.
- Local Worker dev (when `worker.js` exists): `cd backend && wrangler dev`.
- Seed D1 data (optional): `bash scripts/seed_d1.sh` or `powershell -ExecutionPolicy Bypass -File scripts/seed_d1.ps1` — applies `backend/schema.sql` and inserts sample rows.
 - Use local D1 in dev: `wrangler dev` uses SQLite via `backend/wrangler.toml` (binding `DB`). To seed local DB, set `D1_LOCAL=1` when running seed scripts (e.g., `D1_LOCAL=1 bash scripts/seed_d1.sh`).
 - Dev env convenience: Create `frontend/.env.development.local` with `REACT_APP_API_ORIGIN=http://127.0.0.1:8787` and (optional) `REACT_APP_ADMIN_TOKEN=<token>` to auto-inject Authorization for write actions in dev.

## Coding Style & Naming Conventions
- Language: JavaScript/TypeScript welcomed; CRA defaults for frontend; standard Worker JS for backend.
- Indentation: 2 spaces; prefer single quotes; semicolons consistent; concise, descriptive names (`ImageGrid.tsx`, `useImages.ts`).
- Structure: Frontend UI in `frontend/src/components`, pages/views in `frontend/src/pages`, hooks in `frontend/src/hooks`.
- Tools: Prettier + ESLint configs provided in `frontend/`. Format: `cd frontend && npx prettier --write "src/**/*.{js,jsx,ts,tsx,json,css,md}"`. Lint: `npx eslint "src/**/*.{js,jsx,ts,tsx}"` (optional, CRA also lints on build).

## Testing Guidelines
- Preferred: Jest + React Testing Library for frontend (`frontend/src/__tests__` or `*.test.tsx`).
- Worker: Use `wrangler`/Miniflare-based tests if added.
- Aim for smoke coverage on pages and critical utils; keep tests fast and deterministic. Run with `npm test` from `frontend` when configured.

## Commit & Pull Request Guidelines
- Commits: Use Conventional Commits style (e.g., `feat: add image search grid`, `fix: handle empty D1 response`). Scope small, messages imperative and specific.
- PRs: Include purpose, linked issue, screenshots for UI changes, and deployment notes (env vars, routes). Ensure scripts still run: deploy + verify.

## Security & Configuration Tips
- Never commit secrets. Copy `.env.example` to `.env.local` (not tracked) as needed.
- Required env vars: `CLOUDFLARE_API_TOKEN`, `CLOUDFLARE_ACCOUNT_ID`, `CF_PAGES_PROJECT`, `REACT_APP_API_ORIGIN`. Optional: `CF_PAGES_DOMAIN`, `WORKER_ROUTE_PATTERN`, `D1_DB_NAME`.
 - Required env vars: `CLOUDFLARE_API_TOKEN`, `CLOUDFLARE_ACCOUNT_ID`, `CF_PAGES_PROJECT`, `REACT_APP_API_ORIGIN`. Optional: `CF_PAGES_DOMAIN`, `WORKER_ROUTE_PATTERN`, `D1_DB_NAME`, `R2_BUCKET` (binds R2 as `R2`), `ADMIN_TOKEN`.
 - Admin token: When `ADMIN_TOKEN` is set, write/destructive endpoints require `Authorization: Bearer <token>`. Set as a Worker secret for production (`wrangler secret put ADMIN_TOKEN`).
- If frontend install fails, use `scripts/fix_frontend.sh ./frontend` (or `scripts/fix_frontend.ps1 -FrontendPath ./frontend`).
 - Deploy scripts intentionally fail fast when required env vars are missing; set them explicitly before running.
